<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Efectividad de Ventas | Dashboard Dinámico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#f5f6f8; --card:#ffffff; --text:#1f2328; --muted:#6b7280; --border:#e5e7eb;
      --yellow:#f7d75c; --dark:#2f3e50; --orange:#f7942b; --green:#0b7a28;
      --shadow: 0 10px 25px rgba(0,0,0,.06);
      --radius: 12px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    header{
      display:flex; align-items:center; gap:16px;
      padding:18px 24px; background:var(--card); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
    }
    header img{ height:44px; width:auto; }
    header .title-wrap{ display:flex; flex-direction:column; gap:2px; }
    header h1{ margin:0; font-size:20px; letter-spacing:.8px; }
    header .subtitle{ color:var(--muted); font-size:12px; }

    .container{ padding:24px; max-width:1300px; margin:0 auto; }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:14px; box-shadow:var(--shadow);
    }
    .toolbar .left, .toolbar .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{
      border:1px solid var(--border); background:#fff; padding:10px 12px; border-radius:10px;
      cursor:pointer; font-weight:600; font-size:13px;
    }
    .btn:hover{ filter:brightness(.98); }
    .btn.primary{ background:#111827; color:#fff; border-color:#111827; }
    .btn.danger{ background:#ef4444; color:#fff; border-color:#ef4444; }
    .file{
      border:1px dashed var(--border); background:#fff; padding:10px 12px; border-radius:10px;
      display:flex; gap:8px; align-items:center;
    }
    .pill{
      padding:6px 10px; border-radius:999px; background:#f3f4f6; font-size:12px; color:#111827;
      border:1px solid var(--border);
    }
    select, input[type="text"]{
      border:1px solid var(--border); padding:10px 12px; border-radius:10px; font-size:13px;
      background:#fff;
    }

    .grid-kpis{
      margin-top:18px;
      display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:14px;
    }
    .kpi{
      border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; color:#fff; min-height:92px;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .kpi .label{ font-size:12px; opacity:.95; letter-spacing:.3px; }
    .kpi .value{ font-size:34px; line-height:1.1; font-weight:800; margin-top:6px; }
    .kpi .note{ font-size:12px; opacity:.9; margin-top:10px; }
    .kpi.yellow{ background:var(--yellow); color:#111; }
    .kpi.dark{ background:var(--dark); }
    .kpi.orange{ background:var(--orange); }
    .kpi.green{ background:var(--green); }

    .section{
      margin-top:18px;
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .section h2{ margin:0 0 10px 0; font-size:16px; }
    .section .hint{ margin:0 0 12px 0; color:var(--muted); font-size:12px; }

    .cards-row{
      display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:14px;
    }

    table{ width:100%; border-collapse:collapse; font-size:13px; overflow:hidden; border-radius:12px; }
    th, td{ border-bottom:1px solid var(--border); padding:10px 10px; }
    th{ background:#f9fafb; text-align:right; font-weight:800; }
    th:first-child, td:first-child{ text-align:left; }
    tr:hover td{ background:#fcfcfd; }

    .table-top{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .small{ font-size:12px; color:var(--muted); }

    .charts{
      display:grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap:14px;
    }
    canvas{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px; }

    footer{ text-align:center; padding:18px; color:var(--muted); font-size:12px; }

    .toast{
      position:fixed; right:18px; bottom:18px; background:#111827; color:#fff; padding:10px 12px;
      border-radius:12px; box-shadow:var(--shadow); font-size:13px; display:none;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>

<body>

<header>
  <img src="logo.png" alt="Elite Online Media" onerror="this.style.display='none'">
  <div class="title-wrap">
    <h1 id="title">EFECTIVIDAD DE VENTAS — DASHBOARD DINÁMICO</h1>
    <div class="subtitle" id="subtitle">Carga datos (CSV/JSON) para actualizar todo automáticamente.</div>
  </div>
</header>

<div class="container">

  <div class="toolbar">
    <div class="left">
      <div class="file">
        <strong>Datos:</strong>
        <input id="fileInput" type="file" accept=".csv,.json" />
      </div>
      <button class="btn" id="loadSampleBtn">Cargar ejemplo</button>
      <button class="btn danger" id="resetBtn">Reset</button>
      <span class="pill" id="statusPill">Sin datos</span>
    </div>
    <div class="right">
      <label class="small">Modo:</label>
      <select id="modeSelect">
        <option value="auto" selected>Auto-detectar</option>
        <option value="wide">Wide (métrica + 2 fechas + diferencia)</option>
        <option value="long">Long (fecha, métrica, valor)</option>
      </select>

      <label class="small">Buscar:</label>
      <input id="searchInput" type="text" placeholder="Ej: llamadas, facturación, IPC..." />

      <button class="btn primary" id="exportBtn">Exportar tabla (CSV)</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid-kpis" id="kpiGrid"></div>

  <div class="cards-row">
    <!-- Resultados Inbound -->
    <div class="section">
      <h2>Resultados Inbound</h2>
      <p class="hint">Se arma desde el bloque <span class="mono">inbound</span> (JSON) o desde métricas con nombre similar.</p>
      <div id="inboundBox"></div>
    </div>

    <!-- Resumen -->
    <div class="section">
      <h2>Resumen</h2>
      <p class="hint">Diagnóstico automático basado en variaciones.</p>
      <div id="insightsBox"></div>
    </div>
  </div>

  <!-- Tabla comparativa -->
  <div class="section">
    <div class="table-top">
      <div>
        <h2 style="margin:0;">Comparativa Operativa</h2>
        <div class="small" id="tableMeta">—</div>
      </div>
    </div>
    <div style="overflow:auto;">
      <table id="dataTable"></table>
    </div>
  </div>

  <!-- Charts -->
  <div class="section">
    <h2>Análisis Visual</h2>
    <p class="hint">Gráficas generadas automáticamente desde la tabla.</p>
    <div class="charts">
      <canvas id="chartActivity" height="180"></canvas>
      <canvas id="chartRevenue" height="180"></canvas>
    </div>
  </div>

</div>

<footer>
  Elite Online Media · Business Intelligence Dashboard (dinámico)
</footer>

<div class="toast" id="toast"></div>

<script>
/* ---------------------------
   1) DATA MODEL (dinámico)
   Soporta:
   A) JSON recomendado:
      {
        "meta": {"title":"...", "period":"Enero 2026"},
        "kpis":[{"label":"Campañas","value":17,"style":"yellow"}, ...],
        "inbound":{"Inversión":23007,"Monto Vendido":20550,"Leads Generados":800,"Pérdida o Ganancia":-2457,"ROI Vendido":-10.67},
        "comparative":{
          "columns":["Métrica","16/01/2026","19/01/2026","Diferencia"],
          "rows":[["Total de Llamadas (Dials)",1789,2044,255], ...]
        }
      }

   B) CSV "wide" (como tu tabla):
      Métrica,16/01/2026,19/01/2026,Diferencia
      Total de Llamadas (Dials),1789,2044,255
      ...

   C) CSV "long":
      fecha,metrica,valor
      2026-01-16,Total de Llamadas (Dials),1789
      2026-01-19,Total de Llamadas (Dials),2044
      ...
---------------------------- */

let appState = {
  meta: { title: "EFECTIVIDAD DE VENTAS", period: "—" },
  kpis: [],
  inbound: {},
  comparative: { columns: [], rows: [] }
};

let charts = { activity: null, revenue: null };

function toast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(() => t.style.display = 'none', 2200);
}

function setStatus(text){
  document.getElementById('statusPill').textContent = text;
}

function formatNumber(v){
  if (v === null || v === undefined || v === "") return "—";
  const n = (typeof v === "number") ? v : parseNumber(v);
  if (Number.isNaN(n)) return String(v);
  return new Intl.NumberFormat('en-US').format(n);
}

function formatCurrency(v){
  if (v === null || v === undefined || v === "") return "—";
  const n = (typeof v === "number") ? v : parseNumber(v);
  if (Number.isNaN(n)) return String(v);
  return new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', maximumFractionDigits:0 }).format(n);
}

function parseNumber(x){
  if (typeof x === "number") return x;
  if (x === null || x === undefined) return NaN;
  let s = String(x).trim();
  if (!s) return NaN;

  // time values like 35:43:00 -> keep as string (NaN)
  if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(s) || /^\d{1,2}:\d{2}:\d{2}$/.test(s)) return NaN;

  // percents
  s = s.replace('%','');

  // currency and separators
  const neg = s.includes('(') && s.includes(')') ? -1 : 1;
  s = s.replace(/[()\$,]/g,'').replace(/\s+/g,'');
  // handle leading + or -
  let sign = 1;
  if (s.startsWith('+')) { sign = 1; s = s.slice(1); }
  if (s.startsWith('-')) { sign = -1; s = s.slice(1); }

  const n = Number(s);
  return n * sign * neg;
}

function isLikelyCurrency(label){
  const l = label.toLowerCase();
  return l.includes('factur') || l.includes('monto') || l.includes('invers') || l.includes('ipc') || l.includes('$') || l.includes('dinero');
}

function isLikelyPercent(label){
  const l = label.toLowerCase();
  return l.includes('roi') || l.includes('convers') || l.includes('%');
}

function formatValue(label, v){
  if (v === null || v === undefined || v === "") return "—";
  // keep time strings as-is
  if (typeof v === "string" && /^\d{1,2}:\d{2}(:\d{2})?$/.test(v.trim())) return v;
  if (typeof v === "string" && /^\d{1,2}:\d{2}:\d{2}$/.test(v.trim())) return v;

  if (isLikelyCurrency(label)) return formatCurrency(v);
  if (isLikelyPercent(label)){
    const n = (typeof v === "number") ? v : parseNumber(v);
    if (Number.isNaN(n)) return String(v);
    // if already in [0..1] assume ratio; else assume percent number
    const pct = (Math.abs(n) <= 1) ? (n * 100) : n;
    return `${pct.toFixed(2)}%`;
  }
  return formatNumber(v);
}

/* ---------------------------
   2) RENDERERS
---------------------------- */
function renderHeader(){
  const title = document.getElementById('title');
  const subtitle = document.getElementById('subtitle');

  title.textContent = `${appState.meta.title}${appState.meta.period && appState.meta.period !== "—" ? " — " + appState.meta.period : ""}`;
  subtitle.textContent = `Última carga: ${new Date().toLocaleString()}`;
}

function renderKpis(){
  const grid = document.getElementById('kpiGrid');
  grid.innerHTML = "";

  const kpis = (appState.kpis && appState.kpis.length) ? appState.kpis : deriveKpisFromData();

  kpis.forEach(k => {
    const div = document.createElement('div');
    div.className = `kpi ${k.style || 'dark'}`;
    div.innerHTML = `
      <div class="label">${k.label || "KPI"}</div>
      <div class="value">${k.displayValue ?? formatValue(k.label || "", k.value)}</div>
      <div class="note">${k.note || ""}</div>
    `;
    grid.appendChild(div);
  });

  if (!kpis.length){
    grid.innerHTML = `<div class="small">No hay KPIs definidos. (Puedes agregarlos en JSON con "kpis").</div>`;
  }
}

function renderInbound(){
  const box = document.getElementById('inboundBox');
  const inbound = appState.inbound || {};

  // If inbound empty, try detect from comparative metrics
  const merged = Object.keys(inbound).length ? inbound : deriveInboundFromComparative();

  if (!Object.keys(merged).length){
    box.innerHTML = `<div class="small">No se detectó bloque Inbound. (Agrega "inbound" en JSON o métricas equivalentes en la tabla).</div>`;
    return;
  }

  const rows = Object.entries(merged).map(([k,v]) => `
    <tr><td>${k}</td><td style="text-align:right;font-weight:800;">${formatValue(k, v)}</td></tr>
  `).join("");

  box.innerHTML = `
    <div style="overflow:auto;">
      <table>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

function renderInsights(){
  const box = document.getElementById('insightsBox');
  const { columns, rows } = appState.comparative;

  if (!columns?.length || !rows?.length){
    box.innerHTML = `<div class="small">Sin datos comparativos para generar insights.</div>`;
    return;
  }

  const metricCol = 0;
  const dateCols = columns.length >= 3 ? [1,2] : [];
  const diffCol = columns.findIndex(c => String(c).toLowerCase().includes("difer"));

  // basic insights: largest positive/negative diffs (numeric)
  let diffs = [];
  if (diffCol > -1){
    rows.forEach(r => {
      const label = r[metricCol];
      const raw = r[diffCol];
      const n = parseNumber(raw);
      if (!Number.isNaN(n)) diffs.push({ label, diff: n });
    });
  }

  diffs.sort((a,b) => b.diff - a.diff);
  const topUp = diffs.find(d => d.diff > 0);
  const topDown = [...diffs].reverse().find(d => d.diff < 0);

  const bullets = [];
  if (topUp) bullets.push(`Mayor incremento: <b>${topUp.label}</b> (${formatNumber(topUp.diff)})`);
  if (topDown) bullets.push(`Mayor caída: <b>${topDown.label}</b> (${formatNumber(topDown.diff)})`);

  // revenue / billing hint
  const billingRow = rows.find(r => String(r[0]).toLowerCase().includes("factur"));
  if (billingRow && dateCols.length){
    const a = parseNumber(billingRow[dateCols[0]]);
    const b = parseNumber(billingRow[dateCols[1]]);
    if (!Number.isNaN(a) && !Number.isNaN(b)){
      const delta = b - a;
      bullets.push(`Facturación: ${formatCurrency(a)} → ${formatCurrency(b)} (Δ ${formatCurrency(delta)})`);
    }
  }

  // contacts hint
  const contactsRow = rows.find(r => String(r[0]).toLowerCase().includes("contact"));
  if (contactsRow && dateCols.length){
    const a = parseNumber(contactsRow[dateCols[0]]);
    const b = parseNumber(contactsRow[dateCols[1]]);
    if (!Number.isNaN(a) && !Number.isNaN(b)){
      bullets.push(`Contactos: ${formatNumber(a)} → ${formatNumber(b)} (Δ ${formatNumber(b-a)})`);
    }
  }

  if (!bullets.length){
    box.innerHTML = `<div class="small">No se detectaron suficientes métricas numéricas para insights.</div>`;
    return;
  }

  box.innerHTML = `<ul style="margin:0; padding-left:18px;">${bullets.map(b => `<li style="margin:8px 0;">${b}</li>`).join("")}</ul>`;
}

function renderTable(){
  const table = document.getElementById('dataTable');
  const meta = document.getElementById('tableMeta');
  const { columns, rows } = appState.comparative;

  if (!columns?.length || !rows?.length){
    table.innerHTML = `<tr><td class="small">Sin datos para mostrar.</td></tr>`;
    meta.textContent = "—";
    return;
  }

  meta.textContent = `${rows.length} métricas · ${columns.length-1} columnas de valores`;

  const thead = `
    <thead>
      <tr>${columns.map((c,i) => `<th>${c}</th>`).join("")}</tr>
    </thead>
  `;

  const q = document.getElementById('searchInput').value.trim().toLowerCase();

  const filtered = !q ? rows : rows.filter(r => String(r[0]).toLowerCase().includes(q));

  const tbody = `
    <tbody>
      ${filtered.map(r => `
        <tr>
          ${r.map((cell, idx) => {
            if (idx === 0) return `<td>${cell ?? "—"}</td>`;
            const label = r[0] ?? "";
            return `<td>${formatValue(label, cell)}</td>`;
          }).join("")}
        </tr>
      `).join("")}
    </tbody>
  `;

  table.innerHTML = thead + tbody;
}

function renderCharts(){
  const { columns, rows } = appState.comparative;
  const activityCanvas = document.getElementById('chartActivity');
  const revenueCanvas = document.getElementById('chartRevenue');

  if (!columns?.length || columns.length < 3 || !rows?.length){
    destroyCharts();
    return;
  }

  const dateA = columns[1];
  const dateB = columns[2];

  // Build activity chart with common metrics if present, else pick top numeric rows
  const preferred = [
    'total de llamadas', 'dials', 'total de contactos', 'contactos', 'presentaciones', 'presentaciones de producto',
    'éxitos', 'cotizaciones'
  ];

  const pickRows = () => {
    let candidates = [];
    rows.forEach(r => {
      const label = String(r[0] ?? "");
      const la = label.toLowerCase();
      const a = parseNumber(r[1]);
      const b = parseNumber(r[2]);
      if (!Number.isNaN(a) && !Number.isNaN(b)){
        candidates.push({ label, la, a, b });
      }
    });

    const pref = candidates.filter(c => preferred.some(p => c.la.includes(p)));
    if (pref.length >= 3) return pref.slice(0, 8);

    // fallback: biggest absolute values
    candidates.sort((x,y) => (Math.abs(y.a)+Math.abs(y.b)) - (Math.abs(x.a)+Math.abs(x.b)));
    return candidates.slice(0, 8);
  };

  const act = pickRows();

  // Revenue chart: try find Facturación row; else build from any currency-like labels
  const revenueCandidates = rows
    .map(r => ({ label:String(r[0]||""), a:parseNumber(r[1]), b:parseNumber(r[2]) }))
    .filter(x => !Number.isNaN(x.a) && !Number.isNaN(x.b) && isLikelyCurrency(x.label));

  // If facturación exists, use that single series, else use top up to 3 series
  const fact = revenueCandidates.find(x => x.label.toLowerCase().includes("factur"));
  const series = fact ? [fact] : revenueCandidates.slice(0, 3);

  destroyCharts();

  charts.activity = new Chart(activityCanvas, {
    type: 'bar',
    data: {
      labels: act.map(x => x.label),
      datasets: [
        { label: dateA, data: act.map(x => x.a) },
        { label: dateB, data: act.map(x => x.b) }
      ]
    },
    options: {
      responsive:true,
      plugins:{ legend:{ position:'top' } },
      scales:{ x:{ ticks:{ maxRotation:60, minRotation:0 } } }
    }
  });

  charts.revenue = new Chart(revenueCanvas, {
    type: series.length > 1 ? 'bar' : 'line',
    data: {
      labels: [dateA, dateB],
      datasets: series.map(s => ({
        label: s.label,
        data: [s.a, s.b],
        tension: 0.3
      }))
    },
    options: { responsive:true, plugins:{ legend:{ position:'top' } } }
  });
}

function destroyCharts(){
  if (charts.activity) charts.activity.destroy();
  if (charts.revenue) charts.revenue.destroy();
  charts.activity = null; charts.revenue = null;
}

/* ---------------------------
   3) DERIVATIONS (si no hay JSON)
---------------------------- */
function deriveKpisFromData(){
  // Try to build some KPIs from known metrics
  const { rows } = appState.comparative;
  if (!rows?.length) return [];

  const findMetric = (needle) => rows.find(r => String(r[0]).toLowerCase().includes(needle));
  const colA = appState.comparative.columns?.[1];
  const colB = appState.comparative.columns?.[2];

  const calls = findMetric('llamad') || findMetric('dials');
  const contacts = findMetric('contact');
  const pres = findMetric('present');
  const billing = findMetric('factur');

  const k = [];

  if (calls) k.push({ label: `Llamadas (${colB || 'B'})`, value: calls[2] ?? calls[1], style:'dark' });
  if (contacts) k.push({ label: `Contactos (${colB || 'B'})`, value: contacts[2] ?? contacts[1], style:'yellow' });
  if (pres) k.push({ label: `Presentaciones (${colB || 'B'})`, value: pres[2] ?? pres[1], style:'orange' });
  if (billing) k.push({ label: `Facturación (${colB || 'B'})`, value: billing[2] ?? billing[1], style:'green' });

  // ensure at least 3 cards max 6
  return k.slice(0, 6);
}

function deriveInboundFromComparative(){
  const { rows } = appState.comparative;
  if (!rows?.length) return {};
  const pick = (needle) => rows.find(r => String(r[0]).toLowerCase().includes(needle));

  const inv = pick('invers');
  const sold = pick('monto vend');
  const leads = pick('lead gener');
  const pnl = pick('perdida') || pick('ganancia');
  const roi = pick('roi');

  const col = 2; // prefer second date (B)
  const inbound = {};
  if (inv) inbound["Inversión"] = inv[col] ?? inv[1];
  if (sold) inbound["Monto Vendido"] = sold[col] ?? sold[1];
  if (leads) inbound["Leads Generados"] = leads[col] ?? leads[1];
  if (pnl) inbound["Pérdida o Ganancia"] = pnl[col] ?? pnl[1];
  if (roi) inbound["ROI Vendido"] = roi[col] ?? roi[1];
  return inbound;
}

/* ---------------------------
   4) LOADERS (CSV/JSON)
---------------------------- */
function applyDataAndRender(dataObj){
  appState = normalizeDataObject(dataObj);
  renderHeader();
  renderKpis();
  renderInbound();
  renderInsights();
  renderTable();
  renderCharts();
  setStatus("Datos cargados");
  toast("Dashboard actualizado");
}

function normalizeDataObject(obj){
  const out = {
    meta: obj.meta || { title:"EFECTIVIDAD DE VENTAS", period:"—" },
    kpis: Array.isArray(obj.kpis) ? obj.kpis : [],
    inbound: obj.inbound && typeof obj.inbound === "object" ? obj.inbound : {},
    comparative: obj.comparative && typeof obj.comparative === "object" ? obj.comparative : { columns:[], rows:[] }
  };

  // ensure structure
  if (!Array.isArray(out.comparative.columns)) out.comparative.columns = [];
  if (!Array.isArray(out.comparative.rows)) out.comparative.rows = [];

  // If obj itself looks like wide csv parsed {columns,rows}
  if (!out.comparative.columns.length && obj.columns && obj.rows){
    out.comparative.columns = obj.columns;
    out.comparative.rows = obj.rows;
  }

  // Title fallback
  if (!out.meta.title) out.meta.title = "EFECTIVIDAD DE VENTAS";
  return out;
}

function loadFromFile(file){
  const mode = document.getElementById('modeSelect').value;

  if (file.name.toLowerCase().endsWith('.json')){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(reader.result);
        applyDataAndRender(obj);
      } catch(e){
        toast("JSON inválido");
        console.error(e);
      }
    };
    reader.readAsText(file);
    return;
  }

  // CSV
  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: (results) => {
      try{
        const rows = results.data;
        const csvObj = csvToDataObject(rows, mode);
        applyDataAndRender(csvObj);
      } catch(e){
        console.error(e);
        toast("No pude interpretar el CSV. Revisa formato.");
      }
    }
  });
}

function csvToDataObject(rows, mode){
  // auto-detect: if has "fecha" & "metrica" & "valor" => long
  const keys = Object.keys(rows[0] || {}).map(k => k.toLowerCase());
  const hasLong = keys.includes("fecha") && (keys.includes("metrica") || keys.includes("métrica")) && keys.includes("valor");

  if (mode === "long" || (mode === "auto" && hasLong)){
    return longCsvToObj(rows);
  }
  return wideCsvToObj(rows);
}

function wideCsvToObj(rows){
  // Expect first column as metric label, and at least two numeric/date columns
  const cols = Object.keys(rows[0] || {});
  const metricCol = cols[0];

  const columns = ["Métrica", ...cols.slice(1)];
  const outRows = rows.map(r => {
    const arr = [r[metricCol]];
    for (let i=1;i<cols.length;i++){
      arr.push(r[cols[i]]);
    }
    return arr;
  });

  return {
    meta:{ title:"EFECTIVIDAD DE VENTAS", period:"(CSV)" },
    kpis: [],
    inbound: {},
    comparative: { columns, rows: outRows }
  };
}

function longCsvToObj(rows){
  // Convert long to wide by pivoting on fecha
  // expecting columns: fecha, metrica, valor
  const fechaKey = Object.keys(rows[0]).find(k => k.toLowerCase()==="fecha");
  const metKey = Object.keys(rows[0]).find(k => k.toLowerCase()==="metrica" || k.toLowerCase()==="métrica");
  const valKey = Object.keys(rows[0]).find(k => k.toLowerCase()==="valor");

  const fechas = [...new Set(rows.map(r => r[fechaKey]))].sort();
  const metrics = [...new Set(rows.map(r => r[metKey]))];

  // map metric -> {fecha -> valor}
  const map = new Map();
  metrics.forEach(m => map.set(m, {}));
  rows.forEach(r => {
    const m = r[metKey];
    const f = r[fechaKey];
    map.get(m)[f] = r[valKey];
  });

  const columns = ["Métrica", ...fechas];
  const outRows = metrics.map(m => {
    const row = [m];
    fechas.forEach(f => row.push(map.get(m)[f] ?? ""));
    // optional difference if exactly 2 fechas
    if (fechas.length === 2){
      const a = parseNumber(map.get(m)[fechas[0]]);
      const b = parseNumber(map.get(m)[fechas[1]]);
      if (!Number.isNaN(a) && !Number.isNaN(b)){
        // append Diferencia
        row.push(b - a);
      } else {
        row.push("");
      }
    }
    return row;
  });

  if (fechas.length === 2){
    columns.push("Diferencia");
  }

  return {
    meta:{ title:"EFECTIVIDAD DE VENTAS", period:"(CSV long)" },
    kpis: [],
    inbound: {},
    comparative: { columns, rows: outRows }
  };
}

/* ---------------------------
   5) EXPORT
---------------------------- */
function exportTableCsv(){
  const { columns, rows } = appState.comparative;
  if (!columns?.length || !rows?.length){
    toast("No hay tabla para exportar");
    return;
  }
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const filtered = !q ? rows : rows.filter(r => String(r[0]).toLowerCase().includes(q));

  const escape = (v) => {
    const s = String(v ?? "");
    if (s.includes('"') || s.includes(',') || s.includes('\n')) return `"${s.replaceAll('"','""')}"`;
    return s;
  };

  const lines = [];
  lines.push(columns.map(escape).join(','));
  filtered.forEach(r => lines.push(r.map(escape).join(',')));

  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'comparativa_export.csv';
  a.click();
  URL.revokeObjectURL(url);
  toast("CSV exportado");
}

/* ---------------------------
   6) SAMPLE DATA (tu caso)
---------------------------- */
const sample = {
  meta: { title: "EFECTIVIDAD DE VENTAS", period: "ENERO 2026" },
  // Puedes dejarlo vacío y se derivan KPIs desde la tabla
  kpis: [
    { label: "Campañas", value: 17, style: "yellow" },
    { label: "Clientes", value: 32, style: "yellow" },
    { label: "Conversiones MM", value: 15, style: "dark" },
    { label: "Facturado Nuevo en el Mes", displayValue: "$49,050", value: 49050, style: "orange" }
  ],
  inbound: {
    "Inversión": 23007,
    "Monto Vendido": 20550,
    "Lead Generados": 800,
    "Perdida o Ganancia": -2457,
    "ROI Vendido": -10.67
  },
  comparative: {
    columns: ["Métrica","16/01/2026","19/01/2026","Diferencia"],
    rows: [
      ["Total de Llamadas (Dials)", 1789, 2044, 255],
      ["Total de Contactos", 682, 529, -153],
      ["Tiempo Total de Llamada", "35:43:00", "29:28:29", "-6:14:31"],
      ["Éxitos en Five9", 12, 8, -4],
      ["Lead Inbound MM", 0, 0, 0],
      ["Presentaciones de Producto", 5, 11, 6],
      ["Cotizaciones", 2, 1, -1],
      ["Éxitos en HubSpot", 0, 12, 12],
      ["Clientes Referidos", 0, 0, 0],
      ["Clientes Outbound", 0, 0, 0],
      ["Clientes Inbound Meses anteriores", 1, 1, 0],
      ["Cliente Nuevo Lead MM", 2, 1, -1],
      ["Total Clientes", 3, 2, -1],
      ["Facturación Total ($) (Dinero Nuevo)", 3100, 2500, -600],
      ["Campañas Nuevas", 1, 0, -1],
      ["Tiempo Hablado por Agente", "2:22:00", "1:57", "-0:25:00"],
      ["conversión de Clientes", "12.50%", "16.67%", 0],
      ["conversion Inbound MM", "0.00%", "0.00%", 0],
      ["(IPC)", 45.19, 312.50, 267]
    ]
  }
};

/* ---------------------------
   7) EVENTS
---------------------------- */
document.getElementById('fileInput').addEventListener('change', (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  setStatus("Cargando...");
  loadFromFile(file);
});

document.getElementById('loadSampleBtn').addEventListener('click', () => {
  applyDataAndRender(sample);
});

document.getElementById('resetBtn').addEventListener('click', () => {
  appState = { meta:{title:"EFECTIVIDAD DE VENTAS", period:"—"}, kpis:[], inbound:{}, comparative:{columns:[], rows:[]} };
  destroyCharts();
  document.getElementById('kpiGrid').innerHTML = "";
  document.getElementById('inboundBox').innerHTML = "";
  document.getElementById('insightsBox').innerHTML = "";
  document.getElementById('dataTable').innerHTML = "";
  document.getElementById('tableMeta').textContent = "—";
  document.getElementById('searchInput').value = "";
  setStatus("Sin datos");
  toast("Reset listo");
});

document.getElementById('searchInput').addEventListener('input', () => {
  renderTable();
});

document.getElementById('exportBtn').addEventListener('click', exportTableCsv);

// first paint with sample (opcional: comenta esta línea si quieres que inicie vacío)
applyDataAndRender(sample);
</script>

</body>
</html>

 
