<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Ventas (Five9 + HubSpot)</title>

  <!-- Plotly (interactivo) -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <!-- DataTables (tabla interactiva) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

  <style>
    :root { --bg:#0b1020; --card:#111a33; --muted:#a9b4d0; --text:#e8eeff; --line:#223055; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { padding: 18px 18px 8px; border-bottom: 1px solid var(--line); position: sticky; top:0; background: rgba(11,16,32,.92); backdrop-filter: blur(8px); z-index: 5; }
    h1 { margin: 0 0 8px; font-size: 18px; font-weight: 700; }
    .sub { color: var(--muted); font-size: 12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .wrap { padding: 14px 18px 22px; }
    .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 12px; box-shadow: 0 8px 30px rgba(0,0,0,.25); }
    .kpi { display:flex; flex-direction:column; gap:6px; }
    .kpi .label { color: var(--muted); font-size: 12px; }
    .kpi .value { font-size: 22px; font-weight: 800; letter-spacing: .2px; }
    .kpi .hint { color: var(--muted); font-size: 11px; }
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    .control { display:flex; flex-direction:column; gap:6px; }
    label { font-size: 12px; color: var(--muted); }
    select, input, button {
      background:#0d1631; color:var(--text); border:1px solid var(--line);
      border-radius: 10px; padding: 9px 10px; font-size: 13px;
      outline: none;
    }
    button { cursor:pointer; font-weight:700; }
    button:hover { filter: brightness(1.08); }
    .span-12 { grid-column: span 12; }
    .span-8  { grid-column: span 8; }
    .span-6  { grid-column: span 6; }
    .span-4  { grid-column: span 4; }
    .span-3  { grid-column: span 3; }
    .span-2  { grid-column: span 2; }

    .chart { height: 340px; }
    .chart.tall { height: 380px; }

    /* DataTables dark-ish */
    table.dataTable { color: var(--text) !important; }
    table.dataTable thead th { background: #0d1631; color: var(--text); border-bottom: 1px solid var(--line) !important; }
    table.dataTable tbody td { border-top: 1px solid rgba(34,48,85,.35) !important; }
    .dataTables_wrapper .dataTables_filter input,
    .dataTables_wrapper .dataTables_length select {
      background:#0d1631; color:var(--text); border:1px solid var(--line); border-radius: 10px;
      padding: 6px 8px; outline:none;
    }
    .dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_paginate { color: var(--muted) !important; }
    .pill { padding: 3px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color: var(--muted); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    @media (max-width: 1100px){
      .span-8,.span-6,.span-4,.span-3,.span-2{ grid-column: span 12; }
      .chart, .chart.tall { height: 330px; }
    }
  </style>
</head>

<body>
<header>
  <h1>Dashboard Interactivo — Productividad, Éxito (Five9 vs HubSpot) y Facturación</h1>
  <div class="sub">
    <span class="pill" id="pillRange">Rango: —</span>
    <span class="pill" id="pillCount">Registros: —</span>
    <span class="pill">Timezone: America/Mexico_City</span>
  </div>
</header>

<div class="wrap">
  <!-- Filtros -->
  <div class="card span-12" style="margin-bottom:12px;">
    <div class="filters">
      <div class="control">
        <label for="teamSel">Team</label>
        <select id="teamSel"></select>
      </div>
      <div class="control">
        <label for="agentSel">Agente</label>
        <select id="agentSel"></select>
      </div>
      <div class="control">
        <label for="dateFrom">Fecha desde</label>
        <input type="date" id="dateFrom" />
      </div>
      <div class="control">
        <label for="dateTo">Fecha hasta</label>
        <input type="date" id="dateTo" />
      </div>
      <div class="control">
        <label>&nbsp;</label>
        <button id="applyBtn">Aplicar filtros</button>
      </div>
      <div class="control">
        <label>&nbsp;</label>
        <button id="resetBtn">Reset</button>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid">
    <div class="card span-3 kpi">
      <div class="label">Dials</div>
      <div class="value" id="kpiDials">—</div>
      <div class="hint">Total en el filtro</div>
    </div>
    <div class="card span-3 kpi">
      <div class="label">Contacts</div>
      <div class="value" id="kpiContacts">—</div>
      <div class="hint">Total en el filtro</div>
    </div>
    <div class="card span-3 kpi">
      <div class="label">Success (Five9)</div>
      <div class="value" id="kpiS5">—</div>
      <div class="hint">Conversión vs Contacts</div>
    </div>
    <div class="card span-3 kpi">
      <div class="label">Facturado</div>
      <div class="value" id="kpiBill">—</div>
      <div class="hint">Suma en el filtro</div>
    </div>

    <!-- Charts -->
    <div class="card span-8">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div style="font-weight:800;">Dials & Contacts por Agente</div>
          <div style="color:var(--muted); font-size:12px;">Comparativo (barra) — útil para productividad</div>
        </div>
      </div>
      <div id="chartBars" class="chart"></div>
    </div>

    <div class="card span-4">
      <div style="font-weight:800;">Conversión: Five9 vs HubSpot</div>
      <div style="color:var(--muted); font-size:12px;">Éxitos y tasas sobre Contacts</div>
      <div id="chartConv" class="chart"></div>
    </div>

    <div class="card span-6">
      <div style="font-weight:800;">Funnel (Lead → Presentación → Cotización → Success HubSpot)</div>
      <div style="color:var(--muted); font-size:12px;">Suma de conteos en el filtro</div>
      <div id="chartFunnel" class="chart"></div>
    </div>

    <div class="card span-6">
      <div style="font-weight:800;">Facturado por Agente</div>
      <div style="color:var(--muted); font-size:12px;">Top agentes por monto</div>
      <div id="chartBill" class="chart"></div>
    </div>

    <div class="card span-12">
      <div style="font-weight:800; margin-bottom:8px;">Detalle (tabla interactiva)</div>
      <table id="tbl" class="display" style="width:100%">
        <thead>
          <tr>
            <th>Team</th>
            <th>Agente</th>
            <th>Fecha</th>
            <th>Dials</th>
            <th>Contacts</th>
            <th>Success Five9</th>
            <th>Talk Time</th>
            <th>Lead Inbound</th>
            <th>Product Presentation</th>
            <th>Cotización</th>
            <th>Success HubSpot</th>
            <th>Clientes (F. sin Conexión)</th>
            <th>Referido</th>
            <th>Inbound Meses Anteriores</th>
            <th>Nuevos Lead MM</th>
            <th>Total de Clientes</th>
            <th>Campañas</th>
            <th>Facturado</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // =========================
  // 1) DATA (tu tabla)
  // =========================
  // Nota: Campos vacíos -> 0 / null según aplique.
  const raw = [
    {Team:"Equipo de Ventas Anuar",Agente:"Angeles Espinoza",Fecha:"21/01/2026",Dials:314,Contacts:38,SuccessFive9:1,TalkTime:"2:49:44",LeadInbound:0,ProductPresentation:1,Cotizacion:0,SuccessHubspot:1,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:""},
    {Team:"Equipo de Ventas Anuar",Agente:"Geraldine Murillo",Fecha:"21/01/2026",Dials:237,Contacts:28,SuccessFive9:2,TalkTime:"3:14:49",LeadInbound:0,ProductPresentation:2,Cotizacion:0,SuccessHubspot:2,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:"$1,000.00"},
    {Team:"Equipo de Ventas Anuar",Agente:"Judith Mercado",Fecha:"21/01/2026",Dials:195,Contacts:41,SuccessFive9:1,TalkTime:"2:17:36",LeadInbound:0,ProductPresentation:1,Cotizacion:0,SuccessHubspot:1,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:""},
    {Team:"Equipo de Ventas Anuar",Agente:"Rodrigo Guadamuz",Fecha:"21/01/2026",Dials:154,Contacts:17,SuccessFive9:0,TalkTime:"1:43:23",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:""},
    {Team:"Equipo de Ventas Anuar",Agente:"Alexia Rodríguez",Fecha:"21/01/2026",Dials:168,Contacts:25,SuccessFive9:0,TalkTime:"2:27:53",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:"$650.00"},
    {Team:"Equipo de Ventas Anuar",Agente:"Mariett Castro",Fecha:"21/01/2026",Dials:81,Contacts:13,SuccessFive9:1,TalkTime:"3:44:38",LeadInbound:0,ProductPresentation:1,Cotizacion:0,SuccessHubspot:1,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:""},
    {Team:"Post venta",Agente:"Andrea Rivera",Fecha:"21/01/2026",Dials:99,Contacts:79,SuccessFive9:0,TalkTime:"3:00:56",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:1,ClientesSinConexion:0,Referido:1,InboundMesesAnteriores:2,NuevosLeadMM:2,TotalClientes:0,Campanas:0,Facturado:"$1,700.00"},
    {Team:"Post venta",Agente:"Alejandra Rodriguez",Fecha:"21/01/2026",Dials:80,Contacts:55,SuccessFive9:0,TalkTime:"2:34:20",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:"$900.00"},
    {Team:"Post venta",Agente:"Ariana Leiva",Fecha:"21/01/2026",Dials:192,Contacts:95,SuccessFive9:0,TalkTime:"1:04:02",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:"$750.00"},
    {Team:"Post venta",Agente:"David Espinoza",Fecha:"21/01/2026",Dials:0,Contacts:0,SuccessFive9:0,TalkTime:"0:00:00",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:""},
    {Team:"Post venta",Agente:"Jonathan Salinas",Fecha:"21/01/2026",Dials:66,Contacts:61,SuccessFive9:0,TalkTime:"1:56:10",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:""},
    {Team:"Post venta",Agente:"Mario Castano",Fecha:"21/01/2026",Dials:143,Contacts:116,SuccessFive9:0,TalkTime:"1:46:57",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:""},
    {Team:"Post venta",Agente:"Nicole Garcia",Fecha:"21/01/2026",Dials:119,Contacts:71,SuccessFive9:1,TalkTime:"3:04:17",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:1,NuevosLeadMM:1,TotalClientes:0,Campanas:0,Facturado:"$750.00"},
    {Team:"Post venta",Agente:"Paola Paz",Fecha:"21/01/2026",Dials:0,Contacts:0,SuccessFive9:0,TalkTime:"0:00:00",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:""},
    {Team:"Post venta",Agente:"Veronica Ramirez",Fecha:"21/01/2026",Dials:140,Contacts:41,SuccessFive9:0,TalkTime:"2:50:55",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:"$250.00"},

    {Team:"Equipo de Ventas Anuar",Agente:"Angeles Espinoza",Fecha:"22/01/2026",Dials:304,Contacts:38,SuccessFive9:0,TalkTime:"2:41:30",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:1,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:1,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:"$525.00"},
    {Team:"Equipo de Ventas Anuar",Agente:"Geraldine Murillo",Fecha:"22/01/2026",Dials:396,Contacts:64,SuccessFive9:0,TalkTime:"1:40:21",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:""},
    {Team:"Equipo de Ventas Anuar",Agente:"Judith Mercado",Fecha:"22/01/2026",Dials:206,Contacts:27,SuccessFive9:2,TalkTime:"2:44:43",LeadInbound:0,ProductPresentation:2,Cotizacion:0,SuccessHubspot:2,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:""},
    {Team:"Equipo de Ventas Anuar",Agente:"Rodrigo Guadamuz",Fecha:"22/01/2026",Dials:153,Contacts:18,SuccessFive9:1,TalkTime:"4:17:15",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:1,NuevosLeadMM:1,TotalClientes:0,Campanas:0,Facturado:"$300.00"},
    {Team:"Equipo de Ventas Anuar",Agente:"Alexia Rodríguez",Fecha:"22/01/2026",Dials:184,Contacts:20,SuccessFive9:1,TalkTime:"3:06:16",LeadInbound:0,ProductPresentation:1,Cotizacion:0,SuccessHubspot:1,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:""},
    {Team:"Equipo de Ventas Anuar",Agente:"Mariett Castro",Fecha:"22/01/2026",Dials:194,Contacts:24,SuccessFive9:0,TalkTime:"2:20:15",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:"$600.00"},

    {Team:"Post venta",Agente:"Andrea Rivera",Fecha:"22/01/2026",Dials:64,Contacts:44,SuccessFive9:1,TalkTime:"3:31:32",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:"$500.00"},
    {Team:"Post venta",Agente:"Alejandra Rodriguez",Fecha:"22/01/2026",Dials:70,Contacts:48,SuccessFive9:0,TalkTime:"2:21:21",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:1,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:1,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:"$2,850.00"},
    {Team:"Post venta",Agente:"Ariana Leiva",Fecha:"22/01/2026",Dials:149,Contacts:77,SuccessFive9:0,TalkTime:"1:49:14",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:"$550.00"},
    {Team:"Post venta",Agente:"David Espinoza",Fecha:"22/01/2026",Dials:91,Contacts:79,SuccessFive9:0,TalkTime:"2:01:08",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:"$150.00"},
    {Team:"Post venta",Agente:"Jonathan Salinas",Fecha:"22/01/2026",Dials:68,Contacts:62,SuccessFive9:0,TalkTime:"2:53:50",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:"$100.00"},
    {Team:"Post venta",Agente:"Mario Castano",Fecha:"22/01/2026",Dials:144,Contacts:113,SuccessFive9:0,TalkTime:"2:27:33",LeadInbound:1,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:""},
    {Team:"Post venta",Agente:"Nicole Garcia",Fecha:"22/01/2026",Dials:130,Contacts:69,SuccessFive9:1,TalkTime:"2:41:58",LeadInbound:1,ProductPresentation:1,Cotizacion:0,SuccessHubspot:1,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:"$1,000.00"},
    {Team:"Post venta",Agente:"Paola Paz",Fecha:"22/01/2026",Dials:0,Contacts:0,SuccessFive9:0,TalkTime:"0:00:00",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:""},
    {Team:"Post venta",Agente:"Veronica Ramirez",Fecha:"22/01/2026",Dials:218,Contacts:65,SuccessFive9:0,TalkTime:"1:13:44",LeadInbound:0,ProductPresentation:0,Cotizacion:0,SuccessHubspot:0,ClientesSinConexion:0,Referido:0,InboundMesesAnteriores:0,NuevosLeadMM:0,TotalClientes:0,Campanas:0,Facturado:"$536.00"}
  ];

  // =========================
  // 2) HELPERS
  // =========================
  const pad2 = (n) => String(n).padStart(2, '0');

  function parseDDMMYYYY(s){
    // "21/01/2026" -> Date (UTC local) - usamos medianoche local
    const [dd, mm, yyyy] = s.split('/').map(Number);
    return new Date(yyyy, mm - 1, dd, 0, 0, 0, 0);
  }

  function toISODate(d){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function parseHMS(hms){
    // "H:MM:SS" -> seconds
    if(!hms) return 0;
    const parts = hms.split(':').map(Number);
    if(parts.length !== 3) return 0;
    const [h,m,s] = parts;
    return (h*3600) + (m*60) + s;
  }

  function formatHHMMSS(totalSeconds){
    totalSeconds = Math.max(0, Math.round(totalSeconds));
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return `${h}:${pad2(m)}:${pad2(s)}`;
  }

  function parseMoney(v){
    // "$2,850.00" -> 2850
    if(!v) return 0;
    const cleaned = String(v).replace(/\$/g,'').replace(/,/g,'').trim();
    const num = Number(cleaned);
    return Number.isFinite(num) ? num : 0;
  }

  function formatMoney(n){
    const x = Number(n || 0);
    return x.toLocaleString('en-US', { style:'currency', currency:'USD' });
  }

  function uniq(arr){ return Array.from(new Set(arr)); }

  function sum(arr, fn){ return arr.reduce((a,x)=>a + (fn?fn(x):x), 0); }

  function groupBy(arr, keyFn){
    const m = new Map();
    for(const r of arr){
      const k = keyFn(r);
      if(!m.has(k)) m.set(k, []);
      m.get(k).push(r);
    }
    return m;
  }

  // =========================
  // 3) NORMALIZE DATA
  // =========================
  const data = raw.map(r => ({
    ...r,
    FechaDate: parseDDMMYYYY(r.Fecha),
    FechaISO: toISODate(parseDDMMYYYY(r.Fecha)),
    TalkSeconds: parseHMS(r.TalkTime),
    FacturadoNum: parseMoney(r.Facturado),

    // Asegura numéricos
    Dials: Number(r.Dials||0),
    Contacts: Number(r.Contacts||0),
    SuccessFive9: Number(r.SuccessFive9||0),
    LeadInbound: Number(r.LeadInbound||0),
    ProductPresentation: Number(r.ProductPresentation||0),
    Cotizacion: Number(r.Cotizacion||0),
    SuccessHubspot: Number(r.SuccessHubspot||0),
    ClientesSinConexion: Number(r.ClientesSinConexion||0),
    Referido: Number(r.Referido||0),
    InboundMesesAnteriores: Number(r.InboundMesesAnteriores||0),
    NuevosLeadMM: Number(r.NuevosLeadMM||0),
    TotalClientes: Number(r.TotalClientes||0),
    Campanas: Number(r.Campanas||0)
  }));

  // =========================
  // 4) FILTER UI INIT
  // =========================
  const teamSel = document.getElementById('teamSel');
  const agentSel = document.getElementById('agentSel');
  const dateFrom = document.getElementById('dateFrom');
  const dateTo = document.getElementById('dateTo');

  const allTeams = ["(Todos)"].concat(uniq(data.map(d=>d.Team)).sort());
  const allAgents = ["(Todos)"].concat(uniq(data.map(d=>d.Agente)).sort());

  function fillSelect(sel, options){
    sel.innerHTML = "";
    for(const o of options){
      const opt = document.createElement('option');
      opt.value = o;
      opt.textContent = o;
      sel.appendChild(opt);
    }
  }

  fillSelect(teamSel, allTeams);
  fillSelect(agentSel, allAgents);

  // Default date range (min-max)
  const minD = new Date(Math.min(...data.map(d=>d.FechaDate.getTime())));
  const maxD = new Date(Math.max(...data.map(d=>d.FechaDate.getTime())));
  dateFrom.value = toISODate(minD);
  dateTo.value = toISODate(maxD);

  // Keep agents list aligned if Team changes
  teamSel.addEventListener('change', () => {
    const t = teamSel.value;
    const agents = (t === "(Todos)") ? allAgents :
      ["(Todos)"].concat(uniq(data.filter(d=>d.Team===t).map(d=>d.Agente)).sort());
    const current = agentSel.value;
    fillSelect(agentSel, agents);
    if(agents.includes(current)) agentSel.value = current;
  });

  // =========================
  // 5) CORE: APPLY FILTERS
  // =========================
  let dt = null;

  function applyFilters(){
    const t = teamSel.value;
    const a = agentSel.value;
    const from = new Date(dateFrom.value + "T00:00:00");
    const to = new Date(dateTo.value + "T23:59:59");

    const filtered = data.filter(d => {
      const okTeam = (t === "(Todos)") ? true : (d.Team === t);
      const okAgent = (a === "(Todos)") ? true : (d.Agente === a);
      const okDate = (d.FechaDate >= from && d.FechaDate <= to);
      return okTeam && okAgent && okDate;
    });

    // Pills
    document.getElementById('pillRange').textContent = `Rango: ${dateFrom.value} → ${dateTo.value}`;
    document.getElementById('pillCount').textContent = `Registros: ${filtered.length}`;

    // KPIs
    const totalDials = sum(filtered, r=>r.Dials);
    const totalContacts = sum(filtered, r=>r.Contacts);
    const totalS5 = sum(filtered, r=>r.SuccessFive9);
    const totalBill = sum(filtered, r=>r.FacturadoNum);
    const totalTalk = sum(filtered, r=>r.TalkSeconds);

    document.getElementById('kpiDials').textContent = totalDials.toLocaleString('en-US');
    document.getElementById('kpiContacts').textContent = totalContacts.toLocaleString('en-US');

    const s5Rate = totalContacts > 0 ? (totalS5/totalContacts) : 0;
    document.getElementById('kpiS5').textContent = `${totalS5.toLocaleString('en-US')} (${(s5Rate*100).toFixed(1)}%)`;

    document.getElementById('kpiBill').textContent = formatMoney(totalBill);

    // Charts
    renderBars(filtered);
    renderConversion(filtered);
    renderFunnel(filtered);
    renderBilling(filtered);

    // Table
    renderTable(filtered, totalTalk);
  }

  // =========================
  // 6) CHARTS
  // =========================
  function renderBars(filtered){
    const g = groupBy(filtered, r=>r.Agente);
    const agents = Array.from(g.keys()).sort();
    const dials = agents.map(a => sum(g.get(a), r=>r.Dials));
    const contacts = agents.map(a => sum(g.get(a), r=>r.Contacts));

    const traces = [
      { type:'bar', name:'Dials', x: agents, y: dials },
      { type:'bar', name:'Contacts', x: agents, y: contacts }
    ];

    Plotly.newPlot('chartBars', traces, {
      barmode:'group',
      margin:{l:50,r:20,t:20,b:90},
      paper_bgcolor:'rgba(0,0,0,0)',
      plot_bgcolor:'rgba(0,0,0,0)',
      font:{color:'#e8eeff'},
      xaxis:{tickangle:-35, gridcolor:'rgba(34,48,85,.35)'},
      yaxis:{gridcolor:'rgba(34,48,85,.35)'},
      legend:{orientation:'h', y:-0.25}
    }, {displayModeBar:false, responsive:true});
  }

  function renderConversion(filtered){
    const totalContacts = sum(filtered, r=>r.Contacts);
    const totalS5 = sum(filtered, r=>r.SuccessFive9);
    const totalSH = sum(filtered, r=>r.SuccessHubspot);

    const rateS5 = totalContacts>0 ? totalS5/totalContacts : 0;
    const rateSH = totalContacts>0 ? totalSH/totalContacts : 0;

    const x = ['Success Five9','Success HubSpot'];
    const y = [totalS5, totalSH];
    const text = [
      `${(rateS5*100).toFixed(1)}% de Contacts`,
      `${(rateSH*100).toFixed(1)}% de Contacts`
    ];

    Plotly.newPlot('chartConv', [{
      type:'bar',
      x, y,
      text,
      textposition:'auto'
    }], {
      margin:{l:50,r:20,t:20,b:60},
      paper_bgcolor:'rgba(0,0,0,0)',
      plot_bgcolor:'rgba(0,0,0,0)',
      font:{color:'#e8eeff'},
      yaxis:{gridcolor:'rgba(34,48,85,.35)'},
      xaxis:{gridcolor:'rgba(34,48,85,.35)'}
    }, {displayModeBar:false, responsive:true});
  }

  function renderFunnel(filtered){
    const leadInbound = sum(filtered, r=>r.LeadInbound);
    const presentation = sum(filtered, r=>r.ProductPresentation);
    const cot = sum(filtered, r=>r.Cotizacion);
    const successHS = sum(filtered, r=>r.SuccessHubspot);

    const stages = ["Lead Inbound","Product Presentation","Cotización","Success HubSpot"];
    const values = [leadInbound, presentation, cot, successHS];

    Plotly.newPlot('chartFunnel', [{
      type:'funnel',
      y: stages,
      x: values
    }], {
      margin:{l:160,r:20,t:20,b:20},
      paper_bgcolor:'rgba(0,0,0,0)',
      plot_bgcolor:'rgba(0,0,0,0)',
      font:{color:'#e8eeff'}
    }, {displayModeBar:false, responsive:true});
  }

  function renderBilling(filtered){
    const g = groupBy(filtered, r=>r.Agente);
    let rows = Array.from(g.keys()).map(a => ({
      agent: a,
      bill: sum(g.get(a), r=>r.FacturadoNum)
    }));
    rows.sort((x,y)=>y.bill-x.bill);

    const agents = rows.map(r=>r.agent);
    const bill = rows.map(r=>r.bill);

    Plotly.newPlot('chartBill', [{
      type:'bar',
      x: agents,
      y: bill,
      text: bill.map(formatMoney),
      textposition:'auto'
    }], {
      margin:{l:70,r:20,t:20,b:90},
      paper_bgcolor:'rgba(0,0,0,0)',
      plot_bgcolor:'rgba(0,0,0,0)',
      font:{color:'#e8eeff'},
      xaxis:{tickangle:-35, gridcolor:'rgba(34,48,85,.35)'},
      yaxis:{tickprefix:'$', gridcolor:'rgba(34,48,85,.35)'}
    }, {displayModeBar:false, responsive:true});
  }

  // =========================
  // 7) TABLE
  // =========================
  function renderTable(filtered, totalTalkSeconds){
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = "";

    // Agrega un “footer KPI” arriba de la tabla: Talk Time total del filtro
    // (lo ponemos en el buscador de DataTables como info extra)
    const talkStr = formatHHMMSS(totalTalkSeconds);

    for(const r of filtered){
      const tr = document.createElement('tr');
      const cells = [
        r.Team,
        r.Agente,
        r.FechaISO,
        r.Dials,
        r.Contacts,
        r.SuccessFive9,
        r.TalkTime,
        r.LeadInbound,
        r.ProductPresentation,
        r.Cotizacion,
        r.SuccessHubspot,
        r.ClientesSinConexion,
        r.Referido,
        r.InboundMesesAnteriores,
        r.NuevosLeadMM,
        r.TotalClientes,
        r.Campanas,
        formatMoney(r.FacturadoNum)
      ];
      for(const c of cells){
        const td = document.createElement('td');
        td.textContent = c;
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }

    // Re-inicializa DataTable sin duplicar
    if(dt){
      dt.destroy();
      dt = null;
    }
    dt = $('#tbl').DataTable({
      pageLength: 10,
      order: [[2,'asc'], [0,'asc'], [1,'asc']],
      dom: 'lfrtip',
      language: {
        search: "Buscar:",
        lengthMenu: "Mostrar _MENU_",
        info: "Mostrando _START_ a _END_ de _TOTAL_",
        paginate: { previous: "Anterior", next: "Siguiente" }
      }
    });

    // Inserta info extra (Talk Time total) junto al buscador
    setTimeout(() => {
      const filterBox = document.querySelector('#tbl_filter');
      if(filterBox && !document.getElementById('talkPill')){
        const span = document.createElement('span');
        span.id = 'talkPill';
        span.className = 'pill';
        span.style.marginLeft = '10px';
        span.textContent = `Talk Time total: ${talkStr}`;
        filterBox.appendChild(span);
      } else if(document.getElementById('talkPill')){
        document.getElementById('talkPill').textContent = `Talk Time total: ${talkStr}`;
      }
    }, 0);
  }

  // =========================
  // 8) BUTTONS
  // =========================
  document.getElementById('applyBtn').addEventListener('click', applyFilters);

  document.getElementById('resetBtn').addEventListener('click', () => {
    teamSel.value = "(Todos)";
    fillSelect(agentSel, allAgents);
    agentSel.value = "(Todos)";
    dateFrom.value = toISODate(minD);
    dateTo.value = toISODate(maxD);
    applyFilters();
  });

  // =========================
  // 9) FIRST RENDER
  // =========================
  applyFilters();
</script>
</body>
</html>

  
