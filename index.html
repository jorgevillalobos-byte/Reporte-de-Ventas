<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Ops Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root { --bg:#0b1220; --card:#111b2e; --muted:#a9b4c7; --text:#eef2ff; --line:#23314f; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,#070b14 0%, #0b1220 100%); color:var(--text); }
    header{ padding:18px 18px 10px; border-bottom:1px solid var(--line); position:sticky; top:0; background:#0b1220cc; backdrop-filter: blur(8px); z-index:10;}
    h1{ margin:0; font-size:18px; font-weight:700; letter-spacing:.2px; }
    .wrap{ padding:18px; max-width:1300px; margin:0 auto; }
    .grid{ display:grid; gap:12px; }
    .filters{ grid-template-columns: repeat(4,minmax(0,1fr)); }
    .kpis{ grid-template-columns: repeat(5,minmax(0,1fr)); }
    .row2{ grid-template-columns: 2fr 1fr; }
    .row3{ grid-template-columns: 1.2fr 1.8fr; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    select,input{ width:100%; padding:10px 10px; border-radius:12px; border:1px solid var(--line);
      background:#0d1628; color:var(--text); outline:none; }
    .kpi .name{ font-size:12px; color:var(--muted); }
    .kpi .val{ font-size:22px; font-weight:800; margin-top:4px; }
    .kpi .sub{ font-size:12px; color:var(--muted); margin-top:4px; }
    canvas{ width:100% !important; height:320px !important; }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th,td{ padding:10px 8px; border-bottom:1px solid var(--line); }
    th{ text-align:left; color:var(--muted); font-weight:600; }
    tr:hover td{ background:#0d1628; }
    .muted{ color:var(--muted); font-size:12px; }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; background:#0d1628; border:1px solid var(--line); font-size:12px; color:var(--muted); }
    @media (max-width: 1100px){
      .filters{ grid-template-columns: repeat(2,minmax(0,1fr)); }
      .kpis{ grid-template-columns: repeat(2,minmax(0,1fr)); }
      .row2,.row3{ grid-template-columns: 1fr; }
      canvas{ height:260px !important; }
    }
  </style>
</head>

<body>
<header>
  <h1>ðŸ“Š Sales Ops Dashboard (GitHub Pages)</h1>
</header>

<div class="wrap">
  <!-- Filters -->
  <div class="grid filters">
    <div class="card">
      <label>Fecha (desde)</label>
      <input type="date" id="dateStart" />
    </div>
    <div class="card">
      <label>Fecha (hasta)</label>
      <input type="date" id="dateEnd" />
    </div>
    <div class="card">
      <label>Team</label>
      <select id="teamSel"></select>
    </div>
    <div class="card">
      <label>Agente</label>
      <select id="agentSel"></select>
    </div>
  </div>

  <!-- KPIs -->
  <div style="height:12px"></div>
  <div class="grid kpis" id="kpiGrid"></div>

  <!-- Trend + Funnel -->
  <div style="height:12px"></div>
  <div class="grid row2">
    <div class="card">
      <div class="muted">Tendencia por dÃ­a</div>
      <canvas id="trendChart"></canvas>
    </div>
    <div class="card">
      <div class="muted">Funnel (agregado)</div>
      <canvas id="funnelChart"></canvas>
    </div>
  </div>

  <!-- Ranking + Scatter -->
  <div style="height:12px"></div>
  <div class="grid row3">
    <div class="card">
      <div class="muted">
        Ranking por agente (Facturado)
        <span class="pill" id="rankCount"></span>
      </div>
      <div style="overflow:auto; max-height:420px;">
        <table id="rankTable">
          <thead>
            <tr>
              <th>Agente</th><th>Team</th><th>Dials</th><th>Contacts</th><th>Success HS</th><th>Facturado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <div class="muted">Scatter: Contacts vs Facturado (por agente)</div>
      <canvas id="scatterChart"></canvas>
    </div>
  </div>

  <div style="height:16px"></div>
  <div class="muted">
    Data source: <code>data/daily_summary.csv</code> y <code>data/agents_detail.csv</code>
  </div>
</div>

<script>
  // ---------- Utilities ----------
  const money = (x) => (x==null || isNaN(x)) ? "â€”" : new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(x);
  const intf  = (x) => (x==null || isNaN(x)) ? "â€”" : new Intl.NumberFormat("en-US").format(Math.round(x));
  const pct   = (x) => (x==null || isNaN(x)) ? "â€”" : (x*100).toFixed(2) + "%";

  function parseCSV(text){
    // Parser simple para CSV "limpio" (sin comas dentro de valores).
    const lines = text.trim().split(/\r?\n/);
    const headers = lines[0].split(",").map(h=>h.trim());
    return lines.slice(1).map(line=>{
      const cols = line.split(",");
      const obj = {};
      headers.forEach((h,i)=> obj[h] = (cols[i] ?? "").trim());
      return obj;
    });
  }

  function toISODate(s){
    // Acepta "2026-01-21" o "21/01/2026"
    if(!s) return null;
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(m) return `${m[3]}-${m[2]}-${m[1]}`;
    return null;
  }

  function timeToSeconds(hms){
    // "H:MM:SS" o "HH:MM:SS"
    if(!hms) return 0;
    const parts = hms.split(":").map(Number);
    if(parts.length !== 3 || parts.some(n=>isNaN(n))) return 0;
    return parts[0]*3600 + parts[1]*60 + parts[2];
  }

  function sum(arr){ return arr.reduce((a,b)=>a+(+b||0),0); }

  // ---------- Load data ----------
  let daily = [];
  let agents = [];

  async function loadAll(){
    const [d1,d2] = await Promise.all([
      fetch("data/daily_summary.csv").then(r=>r.text()),
      fetch("data/agents_detail.csv").then(r=>r.text()),
    ]);

    daily = parseCSV(d1).map(r=>({
      Fecha: toISODate(r["Fecha"]),
      Dials: +r["Dials"]||0,
      Contacts: +r["Contacts"]||0,
      TalkTimeSec: timeToSeconds(r["Talk Time"]),
      SuccessFive9: +r["Success Five9"]||0,
      LeadInbound: +r["Lead Inbound"]||0,
      Presentation: +r["Product Presentation"]||0,
      Cotizaciones: +r["Cotizaciones"]||0,
      SuccessHubspot: +r["Success Hubspot"]||0,
      Facturado: +r["Facturado"]||0,
      CampaÃ±as: +r["CampaÃ±as"]||0,
    })).filter(r=>r.Fecha);

    agents = parseCSV(d2).map(r=>({
      Team: r["Team"] || "â€”",
      Agente: r["Agente"] || "â€”",
      Fecha: toISODate(r["Fecha"]),
      Dials: +r["Dials"]||0,
      Contacts: +r["Contacts"]||0,
      SuccessFive9: +r["Success Five9"]||0,
      TalkTimeSec: timeToSeconds(r["Talk Time"]),
      LeadInbound: +r["Lead Inbound"]||0,
      Presentation: +r["Product Presentation"]||0,
      Cotizacion: +r["Cotizacion"]||0,
      SuccessHubspot: +r["Success Hubspot"]||0,
      Facturado: +r["Facturado"]||0,
      CampaÃ±as: +r["CampaÃ±as"]||0,
      TotalClientes: +r["Total de Clientes"]||0,
    })).filter(r=>r.Fecha);

    initFilters();
    render();
  }

  // ---------- Filters ----------
  const dateStart = document.getElementById("dateStart");
  const dateEnd = document.getElementById("dateEnd");
  const teamSel = document.getElementById("teamSel");
  const agentSel = document.getElementById("agentSel");

  function initFilters(){
    const allDates = [...new Set([...daily.map(d=>d.Fecha), ...agents.map(a=>a.Fecha)].filter(Boolean))].sort();
    const minD = allDates[0];
    const maxD = allDates[allDates.length-1];

    dateStart.value = minD;
    dateEnd.value = maxD;

    const teams = [...new Set(agents.map(a=>a.Team))].sort();
    teamSel.innerHTML = `<option value="__all__">Todos</option>` + teams.map(t=>`<option value="${t}">${t}</option>`).join("");

    fillAgents();

    [dateStart,dateEnd,teamSel,agentSel].forEach(el=> el.addEventListener("change", render));
    teamSel.addEventListener("change", ()=>{ fillAgents(); render(); });
  }

  function fillAgents(){
    const t = teamSel.value;
    const filtered = (t==="__all__") ? agents : agents.filter(a=>a.Team===t);
    const names = [...new Set(filtered.map(a=>a.Agente))].sort();
    agentSel.innerHTML = `<option value="__all__">Todos</option>` + names.map(n=>`<option value="${n}">${n}</option>`).join("");
  }

  function applyFilters(){
    const s = dateStart.value;
    const e = dateEnd.value;
    const t = teamSel.value;
    const a = agentSel.value;

    const inRange = (x) => x.Fecha && x.Fecha >= s && x.Fecha <= e;

    let a2 = agents.filter(inRange);
    if(t !== "__all__") a2 = a2.filter(x=>x.Team===t);
    if(a !== "__all__") a2 = a2.filter(x=>x.Agente===a);

    let d2 = daily.filter(inRange);
    return {a2, d2};
  }

  // ---------- Charts ----------
  let trendChart, funnelChart, scatterChart;

  function destroy(chart){ if(chart) chart.destroy(); }

  function renderKPIs(rows){
    const totals = {
      dials: sum(rows.map(r=>r.Dials)),
      contacts: sum(rows.map(r=>r.Contacts)),
      s5: sum(rows.map(r=>r.SuccessFive9)),
      sh: sum(rows.map(r=>r.SuccessHubspot)),
      talk: sum(rows.map(r=>r.TalkTimeSec)),
      inbound: sum(rows.map(r=>r.LeadInbound)),
      pres: sum(rows.map(r=>r.Presentation)),
      cot: sum(rows.map(r=>r.Cotizacion)),
      camp: sum(rows.map(r=>r.CampaÃ±as)),
      fact: sum(rows.map(r=>r.Facturado)),
    };

    const contactRate = totals.dials ? totals.contacts / totals.dials : null;
    const successRate = totals.contacts ? totals.sh / totals.contacts : null;
    const factPerSuccess = totals.sh ? totals.fact / totals.sh : null;
    const talkHrs = totals.talk / 3600;

    const kpis = [
      ["Dials", intf(totals.dials), ""],
      ["Contacts", intf(totals.contacts), "Contact Rate: " + (contactRate==null ? "â€”" : pct(contactRate))],
      ["Success Five9", intf(totals.s5), ""],
      ["Success Hubspot", intf(totals.sh), "Success Rate: " + (successRate==null ? "â€”" : pct(successRate))],
      ["Facturado", money(totals.fact), "Facturado/Success: " + (factPerSuccess==null ? "â€”" : money(factPerSuccess))],
      ["Talk Time", talkHrs.toFixed(2) + " h", ""],
      ["Lead Inbound", intf(totals.inbound), ""],
      ["PresentaciÃ³n", intf(totals.pres), ""],
      ["CotizaciÃ³n", intf(totals.cot), ""],
      ["CampaÃ±as", intf(totals.camp), ""],
    ];

    const grid = document.getElementById("kpiGrid");
    grid.innerHTML = kpis.map(([n,v,s])=>`
      <div class="card kpi">
        <div class="name">${n}</div>
        <div class="val">${v}</div>
        <div class="sub">${s || "&nbsp;"}</div>
      </div>
    `).join("");
  }

  function renderTrend(dRows, aRows){
    // Preferimos daily_summary si hay, si no agregamos desde agents
    const byDate = new Map();

    if(dRows.length){
      dRows.slice().sort((x,y)=>x.Fecha.localeCompare(y.Fecha)).forEach(r=>{
        byDate.set(r.Fecha, {Fecha:r.Fecha, Dials:r.Dials, Contacts:r.Contacts, SuccessHS:r.SuccessHubspot, Fact:r.Facturado});
      });
    } else {
      aRows.forEach(r=>{
        if(!byDate.has(r.Fecha)) byDate.set(r.Fecha, {Fecha:r.Fecha, Dials:0, Contacts:0, SuccessHS:0, Fact:0});
        const o = byDate.get(r.Fecha);
        o.Dials += r.Dials; o.Contacts += r.Contacts; o.SuccessHS += r.SuccessHubspot; o.Fact += r.Facturado;
      });
    }

    const trend = [...byDate.values()].sort((x,y)=>x.Fecha.localeCompare(y.Fecha));
    const labels = trend.map(x=>x.Fecha);

    destroy(trendChart);
    trendChart = new Chart(document.getElementById("trendChart"),{
      type:"line",
      data:{
        labels,
        datasets:[
          {label:"Dials", data:trend.map(x=>x.Dials)},
          {label:"Contacts", data:trend.map(x=>x.Contacts)},
          {label:"Success Hubspot", data:trend.map(x=>x.SuccessHS)},
          {label:"Facturado", data:trend.map(x=>x.Fact), yAxisID:"y1"},
        ]
      },
      options:{
        responsive:true,
        interaction:{mode:"index", intersect:false},
        scales:{
          y:{beginAtZero:true},
          y1:{beginAtZero:true, position:"right", grid:{drawOnChartArea:false}}
        }
      }
    });
  }

  function renderFunnel(aRows){
    const inbound = sum(aRows.map(r=>r.LeadInbound));
    const pres = sum(aRows.map(r=>r.Presentation));
    const cot = sum(aRows.map(r=>r.Cotizacion));
    const sh = sum(aRows.map(r=>r.SuccessHubspot));
    const fact = sum(aRows.map(r=>r.Facturado));

    destroy(funnelChart);
    funnelChart = new Chart(document.getElementById("funnelChart"),{
      type:"bar",
      data:{
        labels:["Inbound","PresentaciÃ³n","CotizaciÃ³n","Success HS","Facturado"],
        datasets:[{label:"Valor", data:[inbound,pres,cot,sh,fact]}]
      },
      options:{
        responsive:true,
        scales:{ y:{beginAtZero:true} },
        plugins:{ legend:{display:false} }
      }
    });
  }

  function renderRankingAndScatter(aRows){
    // Agrupar por Team+Agente
    const key = (r)=> `${r.Team}|||${r.Agente}`;
    const map = new Map();
    aRows.forEach(r=>{
      const k = key(r);
      if(!map.has(k)){
        map.set(k, {Team:r.Team, Agente:r.Agente, Dials:0, Contacts:0, SuccessHS:0, Facturado:0});
      }
      const o = map.get(k);
      o.Dials += r.Dials;
      o.Contacts += r.Contacts;
      o.SuccessHS += r.SuccessHubspot;
      o.Facturado += r.Facturado;
    });

    const ranked = [...map.values()].sort((a,b)=> (b.Facturado - a.Facturado));

    // Tabla
    document.getElementById("rankCount").textContent = `${ranked.length} agentes`;
    const tbody = document.querySelector("#rankTable tbody");
    tbody.innerHTML = ranked.map(r=>`
      <tr>
        <td>${r.Agente}</td>
        <td>${r.Team}</td>
        <td>${intf(r.Dials)}</td>
        <td>${intf(r.Contacts)}</td>
        <td>${intf(r.SuccessHS)}</td>
        <td>${money(r.Facturado)}</td>
      </tr>
    `).join("");

    // Scatter
    destroy(scatterChart);
    scatterChart = new Chart(document.getElementById("scatterChart"),{
      type:"scatter",
      data:{
        datasets: [{
          label:"Agentes",
          data: ranked.map(r=>({x:r.Contacts, y:r.Facturado, _name:r.Agente, _team:r.Team, _s:r.SuccessHS}))
        }]
      },
      options:{
        responsive:true,
        plugins:{
          tooltip:{
            callbacks:{
              label: (ctx)=>{
                const p = ctx.raw;
                return `${p._name} (${p._team}) - Contacts: ${intf(p.x)}, Facturado: ${money(p.y)}, Success HS: ${intf(p._s)}`;
              }
            }
          },
          legend:{display:false}
        },
        scales:{
          x:{beginAtZero:true, title:{display:true, text:"Contacts"}},
          y:{beginAtZero:true, title:{display:true, text:"Facturado"}}
        }
      }
    });
  }

  // ---------- Main render ----------
  function render(){
    const {a2, d2} = applyFilters();

    // Para KPIs usamos a2; si estÃ¡ vacÃ­o, intentamos reconstruir desde d2 (sin ranking)
    if(a2.length){
      renderKPIs(a2);
      renderTrend(d2, a2);
      renderFunnel(a2);
      renderRankingAndScatter(a2);
    } else {
      // fallback con daily
      const fake = d2.map(r=>({
        Dials:r.Dials, Contacts:r.Contacts, SuccessFive9:r.SuccessFive9, SuccessHubspot:r.SuccessHubspot,
        TalkTimeSec:r.TalkTimeSec, LeadInbound:r.LeadInbound, Presentation:r.Presentation, Cotizacion:r.Cotizaciones,
        CampaÃ±as:r.CampaÃ±as, Facturado:r.Facturado
      }));
      renderKPIs(fake);
      renderTrend(d2, []);
      renderFunnel(fake);
      document.querySelector("#rankTable tbody").innerHTML = "";
      document.getElementById("rankCount").textContent = "0 agentes";
      destroy(scatterChart);
    }
  }

  // ---------- Start ----------
  loadAll().catch(err=>{
    console.error(err);
    alert("Error cargando CSV. Revisa que existan: data/daily_summary.csv y data/agents_detail.csv");
  });
</script>

</body>
</html>
